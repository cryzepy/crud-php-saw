<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aplikasi CRUD User Menggunakan php</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </head>
  <body style="background-color: #212121">
    <div class="container p-4" style="min-height: 100vh">
      <h1 class="text-center text-white">Aplikasi CRUD User</h1>

      <form class="edit_user d-flex gap-2 my-5" id="form_edit_user">
        <input
          type="text"
          class="form-control"
          placeholder="masukkan nama"
          id="user_name"
        />
        <input type="submit" value="tambah" class="btn btn-primary" />
      </form>

      <div id="list_users"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <script>
      class API {
        constructor(baseURL) {
          this.baseURL = baseURL;
        }

        read() {
          $.ajax({
            url: `${this.baseURL}/api/read.php`,
            method: "GET",
            dataType: "json",
            success: (response) => {
              const { data } = response;
              writeDataToTable(data);
            },
          });
        }

        create(name) {
          $.ajax({
            url: `${this.baseURL}/api/create.php`,
            method: "POST",
            data: { name },
            success: (response) => {
              Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                  toast.onmouseenter = Swal.stopTimer;
                  toast.onmouseleave = Swal.resumeTimer;
                },
              }).fire({
                icon: "success",
                title: `Sukses menambahkan ${name} ke database`,
              });

              $("#user_name").val("");
              this.read();
            },
            error: (err) => {
              Swal.fire({
                icon: "error",
                text: `Database error`,
              });
            },
          });
        }

        delete(id) {
          $.ajax({
            url: `${this.baseURL}/api/delete.php`,
            method: "POST",
            data: { id },
            success: (response) => {
              Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                  toast.onmouseenter = Swal.stopTimer;
                  toast.onmouseleave = Swal.resumeTimer;
                },
              }).fire({
                icon: "success",
                title: "Sukses menghapus user dari database",
              });

              $("#user_name").val("");
              this.read();
            },
            error: (err) => {
              Swal.fire({
                icon: "error",
                text: `Database error`,
              });
            },
          });
        }

        update(id_target, new_name) {
            console.log(id_target)
          $.ajax({
            url: `${this.baseURL}/api/update.php`,
            method: "POST",
            data: { id_target, new_name },
            success: (response) => {
              Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                  toast.onmouseenter = Swal.stopTimer;
                  toast.onmouseleave = Swal.resumeTimer;
                },
              }).fire({
                icon: "success",
                title: `Sukses menyunting user`,
              });

              this.read();
            },
            error: (err) => {
              Swal.fire({
                icon: "error",
                text: `Database error`,
              });
            },
          });
        }
      }

      const api = new API("http://localhost:8000");

      $(function () {
        let mode_add = true;
        let users = [];

        $("#form_edit_user").on("submit", (e) => {
          e.preventDefault();

          const name = $("#user_name").val().trim();

          if (!name) {
            Swal.fire({
              icon: "error",
              title: "Oops...",
              text: "Masukkan nama terlebih dahulu!",
            });
            return;
          }

          api.create(name);
        });

        api.read();
      });

      function writeDataToTable(users) {
        if (!users.length) {
          $("#list_users").html(
            "<span class='text-white fs-3 ms-3'>Tidak ada user</span>"
          );
          return;
        }

        const table = $(`<table class="table">
                <thead>
                  <tr>
                    <th scope="col">No</th>
                    <th scope="col">User</th>
                    <th scope="col">Action</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>`);

        $("#list_users").empty().append(table);

        users.forEach((user, index) => {
          const row = `<tr>
                    <th scope="row">${index + 1}</th>
                    <td>${user.name}</td>
                    <td class="d-flex gap-3">
                      <button class="btn btn-danger d-flex gap-2 delete-user" data-id="${
                        user.id
                      }" data-name="${user.name}">
                          <i class="bi bi-trash-fill"></i>
                          <span>delete</span>
                      </button>
                        <button type="submit" class="btn btn-warning d-flex gap-2 update-user" data-id="${
                        user.id
                      }" data-name="${user.name}">
                          <i class="bi bi-pencil-square"></i>
                          <span>update</span>
                          </button>
                    </td>
                  </tr>`;

          $("#list_users tbody").append(row);
        });

        $(".delete-user").on("click", function () {
          const userId = $(this).data("id");
          const name = $(this).data("name");

          Swal.fire({
            text: `Apakah kamu yakin ingin menghapus ${name} dari database?`,
            showDenyButton: true,
            showCancelButton: true,
            showConfirmButton: false,
            denyButtonText: "lanjutkan, hapus",
            cancelButtonText: "Batal",
            icon: "question",
          }).then((result) => {
            if (result.isDenied) {
              api.delete(userId);
            }
          });
        });

        $(".update-user").on("click", async function () {
          const userId = $(this).data("id");
          const name = $(this).data("name");

          const update = await Swal.fire({
            title: name,
            input: "text",
            inputLabel: "Masukkan nama baru",
            showCancelButton: true,
            inputValidator: (value) => {
              if (!value.trim()) {
                return "masukkan nama dengan benar";
              } else if(value == name){
                return "nama harus berbeda dengan sebelumnya"
              }
            },
          });
          if (update.isConfirmed) {
            api.update(userId, update.value);
          }
        });
      }
    </script>
  </body>
</html>
